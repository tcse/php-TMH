<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–ª–æ–≥ –∞—Ä—Ç–∏—Å—Ç–∞ | Chuyakov Project</title>
    <link rel="alternate" type="application/rss+xml" title="RSS-–ª–µ–Ω—Ç–∞ –±–ª–æ–≥–∞" href="core/generate_rss.php" />

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Swiper.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" href="https://placehold.co/32x32/121212/1DB954?text=üéµ" type="image/png">

    <style>
        :root {
            --bg: #121212;
            --text: #e0e0e0;
            --card-bg: #1e1e1e;
            --border: #333;
            --accent: #1DB954;
        }

        [data-theme="light"] {
            --bg: #f8f9fa;
            --text: #212529;
            --card-bg: #fff;
            --border: #dee2e6;
            --accent: #198754;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            padding-top: 70px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        .header {
            background-color: #121212;
            color: white;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1DB954;
        }

        .logo i {
            margin-right: 8px;
        }

        .footer {
            margin-top: auto;
            background-color: #121212;
            color: #888;
            text-align: center;
            padding: 1rem 0;
            font-size: 0.9rem;
        }

        .post-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 2rem;
            background: var(--card-bg);
        }

        .post-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .post-img {
            width: 100%;
            height: 20rem;
            object-fit: cover;
            border-bottom: 1px solid var(--border);
        }

        .post-excerpt {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .btn-read-more {
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
        }

        .back-link {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 2rem 0;
        }

        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .single-post img {
            max-width: 100%;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .swiper {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
        }

        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: grab;
        }

        .swiper-slide img:active {
            cursor: grabbing;
        }

        .gallery-title {
            font-size: 1.1rem;
            margin: 1rem 0 0.5rem 0;
            color: var(--accent);
        }
    </style>
</head>
<body data-theme="dark">

    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark">
                <a class="navbar-brand logo" href="./index.html">
                    <i class="bi bi-music-note-beamed"></i> Chuyakov Project
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="https://t.me/streetepic" target="_blank">
                                <i class="bi bi-telegram"></i> –ö–∞–Ω–∞–ª
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="player.html" target="_blank">
                                <i class="bi bi-play-circle"></i> –ü–ª–µ–µ—Ä
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="core/generate_rss.php" target="_blank" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-rss"></i> RSS
                            </a>
                        </li>
                        <li class="nav-item">
                            <button class="theme-toggle nav-link" id="themeToggle">
                                <i class="bi bi-moon-stars"></i>
                            </button>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="flex-grow-1">
        <div class="container">

            <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤ -->
            <div id="posts-list" class="posts-list">
                <h2 class="mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h2>
                <div id="posts-container"></div>
                <div class="pagination" id="pagination"></div>
            </div>

            <!-- –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Å—Ç -->
            <div id="single-post" class="single-post" style="display: none;">
                <a href="./blog.html" class="back-link">&larr; –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
                <h1 id="single-post-title"></h1>
                <small id="single-post-date" class="d-block mb-2"></small>
                <div id="single-post-content"></div>
                <div id="single-post-gallery"></div>
                <img id="single-post-image" src="" alt="–û–±–ª–æ–∂–∫–∞" style="display: none;">
                <p>
                    <a id="single-post-link" href="" target="_blank" class="btn btn-outline-success btn-sm mt-3">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—É –≤ Telegram
                    </a>
                </p>
            </div>

        </div>
    </main>

    <!-- –ü–æ–¥–≤–∞–ª -->
    <footer class="footer">
        <div class="container">
            <p>¬© 2025 Chuyakov Project. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            <p>–°–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ <a href="https://github.com/tcse/php-TMH" class="text-decoration-none" target="_blank">TMH by TCSE</a></p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script>
        // === –¢–µ–º–∞ ===
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle.querySelector('i');
        const body = document.body;

        const savedTheme = localStorage.getItem('blog-theme') || 'dark';
        setTheme(savedTheme);

        themeToggle.addEventListener('click', () => {
            const newTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        function setTheme(theme) {
            body.setAttribute('data-theme', theme);
            localStorage.setItem('blog-theme', theme);
            themeIcon.className = theme === 'dark' ? 'bi bi-sun' : 'bi bi-moon-stars';
        }

        // === –ü–∞–≥–∏–Ω–∞—Ü–∏—è ===
        const postsPerPage = 10;
        let currentPage = 1;
        let allPosts = [];

        // === –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ ===
        fetch('core/channel_proxy.php')
            .then(r => r.json())
            .then(data => {
                allPosts = data.posts.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderPosts();
            })
            .catch(err => {
                document.getElementById('posts-container').innerHTML = '<p class="text-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª–æ–≥–∞.</p>';
                console.error('–û—à–∏–±–∫–∞:', err);
            });

        function renderPosts() {
            const container = document.getElementById('posts-container');
            const pagination = document.getElementById('pagination');
            container.innerHTML = '';
            pagination.innerHTML = '';

            const start = (currentPage - 1) * postsPerPage;
            const end = start + postsPerPage;
            const pagePosts = allPosts.slice(start, end);

            if (pagePosts.length === 0 && currentPage === 1) {
                container.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>';
                return;
            }

            pagePosts.forEach(post => {
                const title = getPostTitle(post);
                const textPreview = (post.text || '') + (post.caption ? '\n\n' + post.caption : '');
                const excerpt = textPreview.length > 200 
                    ? textPreview.substring(0, 200) + '...' 
                    : textPreview;

                const card = document.createElement('div');
                card.className = 'post-card';

                let photoHtml = '';
                // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
                if (post.photo_file_id) {
                    const proxy = `core/blog_cover.php?file_id=${encodeURIComponent(post.photo_file_id)}`;
                    photoHtml = `<img src="${proxy}" class="post-img" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">`;
                } else if (post.photos && post.photos.length > 0) {
                    const firstFileId = post.photos[0].file_id;
                    const proxy = `core/blog_cover.php?file_id=${encodeURIComponent(firstFileId)}`;
                    photoHtml = `<img src="${proxy}" class="post-img" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">`;
                }

                card.innerHTML = `
                    ${photoHtml}
                    <div class="p-3">
                        <h3>${title}</h3>
                        <small class="post-date">üìÖ ${post.date}</small>
                        <div class="post-excerpt">${excerpt.replace(/\n/g, '<br>')}</div>
                        <button class="btn btn-sm btn-outline-secondary btn-read-more" data-id="${post.id}">
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                    </div>
                `;
                container.appendChild(card);

                card.querySelector('.btn-read-more').addEventListener('click', () => {
                    window.location.hash = `post=${post.id}`;
                    loadPost(post.id);
                });
            });

            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const totalPages = Math.ceil(allPosts.length / postsPerPage);
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
                btn.disabled = i === currentPage;
                btn.addEventListener('click', () => {
                    currentPage = i;
                    renderPosts();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                pagination.appendChild(btn);
            }
        }

        // === –ü–æ–ª—É—á–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ ===
        function getPostTitle(post) {
            const text = post.text || '';
            const caption = post.caption || '';
            const source = text.trim() ? text : caption;
            return source.split('\n')[0].trim() || '–ù–æ–≤—ã–π –ø–æ—Å—Ç';
        }

        // === –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–¥–∏–Ω –ø–æ—Å—Ç ===
        function loadPost(postId) {
            const post = allPosts.find(p => p.id == postId);
            if (!post) return;

            const postsList = document.getElementById('posts-list');
            const singlePost = document.getElementById('single-post');

            postsList.style.display = 'none';
            singlePost.style.display = 'block';

            document.getElementById('single-post-title').textContent = getPostTitle(post);
            document.getElementById('single-post-date').textContent = `üìÖ ${post.date}`;

            const contentEl = document.getElementById('single-post-content');
            const fullText = (post.text || '') + (post.caption ? '\n\n' + post.caption : '');
            contentEl.innerHTML = makeLinksClickable(
                fullText
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '<')
                    .replace(/>/g, '>')
                    .replace(/\n/g, '<br>')
            );

            // === –ê—É–¥–∏–æ ===
            if (post.audio) {
                const audioEl = document.createElement('audio');
                audioEl.controls = true;
                audioEl.style.width = '100%';
                audioEl.style.margin = '1rem 0';
                audioEl.src = `core/stream.php?id=${post.audio.file_id}`;
                audioEl.addEventListener('play', () => {
                    fetch('core/update_play.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_id: post.audio.file_id })
                    });
                });
                contentEl.appendChild(audioEl);
            }

            // === –ì–∞–ª–µ—Ä–µ—è (–∞–ª—å–±–æ–º) ===
            const galleryEl = document.getElementById('single-post-gallery');
            galleryEl.innerHTML = '';

            if (post.photos && post.photos.length > 0) {
                const galleryTitle = document.createElement('div');
                galleryTitle.className = 'gallery-title';
                galleryTitle.textContent = `–§–æ—Ç–æ–≥–∞–ª–µ—Ä–µ—è (${post.photos.length} —Ñ–æ—Ç–æ)`;
                galleryEl.appendChild(galleryTitle);

                const swiperContainer = document.createElement('div');
                swiperContainer.className = 'swiper';
                swiperContainer.innerHTML = `
                    <div class="swiper-wrapper"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-pagination"></div>
                `;
                galleryEl.appendChild(swiperContainer);

                const wrapper = swiperContainer.querySelector('.swiper-wrapper');
                post.photos.forEach(photo => {
                    const file_id = photo.file_id;
                    const proxyUrl = `core/blog_cover.php?file_id=${encodeURIComponent(file_id)}`;
                    const slide = document.createElement('div');
                    slide.className = 'swiper-slide';
                    slide.innerHTML = `<img src="${proxyUrl}" alt="–§–æ—Ç–æ">`;
                    // ‚ùå –ö–ª–∏–∫ –ø–æ —Å–ª–∞–π–¥—É –æ—Ç–∫–ª—é—á—ë–Ω
                    slide.style.cursor = 'default';
                    wrapper.appendChild(slide);
                });

                // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Swiper —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                new Swiper(swiperContainer, {
                    loop: false,
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev',
                    },
                    pagination: {
                        el: '.swiper-pagination',
                        clickable: true,
                    },
                    slidesPerView: 1,
                    spaceBetween: 10,
                    autoplay: {
                        delay: 5000,
                        disableOnInteraction: false,
                    },
                    breakpoints: {
                        640: { slidesPerView: 1.2 },
                        768: { slidesPerView: 1.5 },
                        1024: { slidesPerView: 2 }
                    }
                });
            }

            // === –û–¥–∏–Ω–æ—á–Ω–æ–µ —Ñ–æ—Ç–æ ===
            const imgEl = document.getElementById('single-post-image');
            if (post.photo_file_id && !post.photos) {
                const proxy = `core/blog_cover.php?file_id=${encodeURIComponent(post.photo_file_id)}`;
                imgEl.src = proxy;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            // === –°—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª ===
            const linkEl = document.getElementById('single-post-link');
            linkEl.href = `https://t.me/chuyakov_project/${postId}`;
        }

        // === –î–µ–ª–∞–µ–º —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ ===
        function makeLinksClickable(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => {
                return `<a href="${url}" target="_blank" rel="noopener" style="color:#1DB954;">${url}</a>`;
            });
        }

        // === –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ö—ç—à–∞ ===
        window.addEventListener('hashchange', () => {
            const match = window.location.hash.match(/post=(\d+)/);
            if (match) {
                loadPost(match[1]);
            } else {
                document.getElementById('single-post').style.display = 'none';
                document.getElementById('posts-list').style.display = 'block';
                window.scrollTo({ top: 0 });
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        if (window.location.hash.startsWith('#post=')) {
            window.dispatchEvent(new Event('hashchange'));
        }
    </script>
</body>
</html>